language: go
os: linux
go:
  - 1.x
branches:
  only:
    - main
install:
  - curl -fsSL https://get.pulumi.com/ | bash
  - export PATH="$HOME/.pulumi/bin:$PATH"
before_script:
  - chmod +x ./scripts/*.sh
services:
  - docker
env:
  - PULUMI_ACCESS_TOKEN: ${PULUMI_ACCESS_TOKEN}

jobs:
  include:
    - name: Login
        uses: docker://pulumi/actions:v1.0.0
        with:
          args: login gs://xxx
        env:
          PULUMI_CREDENTIALS_PATH: /github/home/.pulumi
    - stage: pulumi-preview
      script: ./scripts/pulumi-preview.sh
      if: type = pull_request
    - stage: pulumi-up
      script: ./scripts/run-pulumi.sh
      if: type = push